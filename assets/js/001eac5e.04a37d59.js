"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[563],{5340:(e,s,i)=>{i.r(s),i.d(s,{assets:()=>d,contentTitle:()=>a,default:()=>p,frontMatter:()=>l,metadata:()=>n,toc:()=>o});const n=JSON.parse('{"id":"tp/09","title":"TP 09 - M\xe9moire Virtuelle (Mappage de fichiers)","description":"Fonctionnement de la la m\xe9moire virtuelle, Inspection de la disposition de la m\xe9moire de processus (pmap), Mappage de fichiers et de pages vides en m\xe9moire","source":"@site/versioned_docs/version-2024/tp/09.md","sourceDirName":"tp","slug":"/tp/09","permalink":"/docs/2024/tp/09","draft":false,"unlisted":false,"editUrl":"https://github.com/UPB-FILS-SdE2/upb-fils-sde2.github.io/edit/main/versioned_docs/version-2024/tp/09.md","tags":[],"version":"2024","sidebarPosition":9,"frontMatter":{"sidebar_position":9,"description":"Fonctionnement de la la m\xe9moire virtuelle, Inspection de la disposition de la m\xe9moire de processus (pmap), Mappage de fichiers et de pages vides en m\xe9moire"},"sidebar":"tutorialSidebar","previous":{"title":"TP 08 - M\xe9moire Virtuelle","permalink":"/docs/2024/tp/08"},"next":{"title":"TP 10 - Fils d\'Execution","permalink":"/docs/2024/tp/10"}}');var r=i(4848),t=i(8453);const l={sidebar_position:9,description:"Fonctionnement de la la m\xe9moire virtuelle, Inspection de la disposition de la m\xe9moire de processus (pmap), Mappage de fichiers et de pages vides en m\xe9moire"},a="TP 09 - M\xe9moire Virtuelle (Mappage de fichiers)",d={},o=[{value:"Resources",id:"resources",level:2},{value:"Mappage de fichiers",id:"mappage-de-fichiers",level:2},{value:"mmap",id:"mmap",level:3},{value:"shm_open",id:"shm_open",level:3},{value:"Exercises",id:"exercises",level:2}];function c(e){const s={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.header,{children:(0,r.jsx)(s.h1,{id:"tp-09---m\xe9moire-virtuelle-mappage-de-fichiers",children:"TP 09 - M\xe9moire Virtuelle (Mappage de fichiers)"})}),"\n",(0,r.jsx)(s.h2,{id:"resources",children:"Resources"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsx)(s.p,{children:"Fonctions de mappage de la m\xe9moire:"}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.a,{href:"https://docs.rs/nix/latest/nix/sys/mman/fn.mmap.html",children:"mmap"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.a,{href:"https://docs.rs/nix/latest/nix/sys/mman/fn.mprotect.html",children:"mprotect"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.a,{href:"https://docs.rs/nix/latest/nix/sys/mman/fn.munmap.html",children:"munmap"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsx)(s.p,{children:"Indicateurs de protection de la m\xe9moire"}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.a,{href:"https://docs.rs/nix/latest/nix/sys/mman/struct.ProtFlags.html",children:"ProtFlags"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.a,{href:"https://docs.rs/nix/latest/nix/sys/mman/struct.MapFlags.html",children:"MapFlags"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsx)(s.p,{children:"Autre fonctions utiles"}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.a,{href:"https://docs.rs/nix/latest/nix/unistd/fn.ftruncate.html",children:"ftruncate"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.a,{href:"https://docs.rs/nix/latest/nix/sys/mman/fn.shm_open.html",children:"shm_open en Rust"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"mappage-de-fichiers",children:"Mappage de fichiers"}),"\n",(0,r.jsxs)(s.p,{children:["Apr\xe8s avoir mapp\xe9 un fichier \xe0 l'espace d'adressage du processus, l'acc\xe8s \xe0 ce fichier peut se faire de la m\xeame mani\xe8re que l'acc\xe8s aux donn\xe9es \xe0 partir d'un vecteur. L'efficacit\xe9 de la m\xe9thode vient du fait que la zone m\xe9moire est g\xe9r\xe9e de la m\xeame mani\xe8re que la m\xe9moire virtuelle, soumise aux r\xe8gles d'\xe9vacuation du disque lorsque la m\xe9moire devient insuffisante (de cette fa\xe7on on peut travailler avec des mappages qui d\xe9passent la taille effective de la m\xe9moire physique). De plus, la partie ",(0,r.jsx)(s.code,{children:"I / O"})," est r\xe9alis\xe9e par le noyau, le programmeur \xe9crivant du code qui ne r\xe9cup\xe8re / stocke que les valeurs de / dans la r\xe9gion mapp\xe9e. Ainsi, il n'est plus appel\xe9 ",(0,r.jsx)(s.code,{children:"read"})," , ",(0,r.jsx)(s.code,{children:"write"})," , ",(0,r.jsx)(s.code,{children:"lseek"})," - ce qui simplifie souvent l'\xe9criture de code."]}),"\n",(0,r.jsx)(s.admonition,{type:"note",children:(0,r.jsxs)(s.p,{children:["Tous les descripteurs de fichiers ne peuvent pas \xeatre mapp\xe9s en m\xe9moire. Les sockets, les tuyaux, les p\xe9riph\xe9riques qui n'autorisent que l'acc\xe8s s\xe9quentiel (par exemple, le p\xe9riph\xe9rique char) sont incompatibles avec les concepts de mappage. Il existe des cas o\xf9 les fichiers normaux ne peuvent pas \xeatre mapp\xe9s (par exemple, s'ils n'\xe9taient pas ouverts pour plus de lisibilit\xe9; pour plus d'informations: ",(0,r.jsx)(s.strong,{children:"man mmap"})," )."]})}),"\n",(0,r.jsx)(s.h3,{id:"mmap",children:"mmap"}),"\n",(0,r.jsxs)(s.p,{children:["Prototype de fonction ",(0,r.jsx)(s.a,{href:"https://linux.die.net/man/2/mmap",children:"mmap"})," qui permet le mappage d'un fichier \xe0 l'espace d'adressage du processus est le suivant:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-c",children:"void *mmap(void *start, size_t length, int prot, int flags, int fd, off_t offset);\n"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-rust",children:"pub unsafe fn mmap(\n    addr: Option<NonZeroUsize>,\n    length: NonZeroUsize,\n    prot: ProtFlags,\n    flags: MapFlags,\n    fd: RawFd,\n    offset: off_t\n) -> Result<*mut c_void>\n"})}),"\n",(0,r.jsxs)(s.p,{children:["La fonction retournera en cas d'erreur ",(0,r.jsx)(s.code,{children:"MAP_FAILED"})," . Si le mappage a r\xe9ussi, il renverra un pointeur vers une zone de m\xe9moire dans l'espace d'adressage du processus, la zone o\xf9 le fichier d\xe9crit par le descripteur ",(0,r.jsx)(s.code,{children:"fd"})," a \xe9t\xe9 mapp\xe9, en commen\xe7ant par l'offset. L'utilisation du param\xe8tre ",(0,r.jsx)(s.code,{children:"start"})," vous permet de proposer une zone m\xe9moire sp\xe9cifique \xe0 mapper. L'utilisation de la valeur ",(0,r.jsx)(s.code,{children:"NULL"})," pour le param\xe8tre start indique l'absence de pr\xe9f\xe9rence concernant la zone dans laquelle l'allocation sera effectu\xe9e. L'adresse sp\xe9cifi\xe9e par le param\xe8tre ",(0,r.jsx)(s.code,{children:"start"})," doit \xeatre multiple de la ",(0,r.jsx)(s.em,{children:"taille d'une page"})," . Si le syst\xe8me d'exploitation ne peut pas mapper le fichier \xe0 l'adresse requise, il le mappera \xe0 un emplacement proche et multiple de la taille d'une page. L'adresse la plus appropri\xe9e est \xe9galement retourn\xe9e."]}),"\n",(0,r.jsxs)(s.p,{children:["Le param\xe8tre ",(0,r.jsx)(s.code,{children:"prot"})," sp\xe9cifie le type d'acc\xe8s souhait\xe9:"]}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"PROT_READ"})," (lire)"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"PROT_WRITE"})," (\xe9crire)"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"PROT_EXEC"})," (ex\xe9cution)"]}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.code,{children:"PROT_NONE"})}),"\n"]}),"\n",(0,r.jsxs)(s.p,{children:["Lorsque la zone est utilis\xe9e autrement que ce qui est indiqu\xe9, un signal ",(0,r.jsx)(s.code,{children:"SIGSEGV"})," est g\xe9n\xe9r\xe9."]}),"\n",(0,r.jsxs)(s.p,{children:["Le param\xe8tre ",(0,r.jsx)(s.code,{children:"flags"})," vous permet de d\xe9finir le type de mappage que vous souhaitez; il peut prendre les valeurs suivantes (combin\xe9es par OR en bits; il doit y avoir au moins ",(0,r.jsx)(s.code,{children:"MAP_PRIVATE"})," ou ",(0,r.jsx)(s.code,{children:"MAP_SHARED"}),"):"]}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"MAP_PRIVATE"})," - Utilisez une politique de ",(0,r.jsx)(s.em,{children:"copie sur \xe9criture"})," . La zone contiendra initialement une copie du fichier, mais les \xe9critures ne sont pas effectu\xe9es dans le fichier. Les modifications ",(0,r.jsx)(s.em,{children:"ne seront pas visibles dans les autres processus"}),", s'il y a plusieurs processus qui ont fait \u201cmmap\u201d sur la m\xeame zone du m\xeame fichier."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"MAP_SHARED"})," - Les entr\xe9es sont mises \xe0 jour imm\xe9diatement dans tous les mappages existants. De cette fa\xe7on, tous les processus qui ont effectu\xe9 des mappages verront les modifications. En effet, les mappages ",(0,r.jsx)(s.code,{children:"MAP_SHARED"})," sont effectu\xe9s sur les pages physiques du cache de pages et les appels ",(0,r.jsx)(s.code,{children:"r / w"})," utilisent les pages physiques du cache de pages pour r\xe9duire le nombre de lectures / \xe9critures \xe0 partir du disque. Les mises \xe0 jour du disque auront lieu ult\xe9rieurement, sans pr\xe9cision."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"MAP_FIXED"})," - Si l'affectation \xe0 l'adresse sp\xe9cifi\xe9e par ",(0,r.jsx)(s.code,{children:"start"})," ne peut pas \xeatre effectu\xe9e, l'appel \xe9chouera"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"MAP_LOCKED"})," - Cette page sera bloqu\xe9e de cette mani\xe8re ",(0,r.jsx)(s.a,{href:"https://linux.die.net/man/2/mlock",children:"mlock"})]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"MAP_ANONYMOUS"})," - Mappe la RAM (les arguments ",(0,r.jsx)(s.code,{children:"fd"})," et ",(0,r.jsx)(s.code,{children:"offset"})," sont ignor\xe9s)"]}),"\n"]}),"\n",(0,r.jsxs)(s.p,{children:["Il est \xe0 noter que l'utilisation de ",(0,r.jsx)(s.code,{children:"MAP_SHARED"})," permet le partage de m\xe9moire entre des processus qui ne sont pas li\xe9s. Dans ce cas, le contenu du fichier devient le contenu initial de la m\xe9moire partag\xe9e et toutes les modifications apport\xe9es par les processus dans cette zone sont ensuite copi\xe9es dans le fichier, garantissant ainsi la persistance dans le syst\xe8me de fichiers."]}),"\n",(0,r.jsx)(s.h3,{id:"shm_open",children:"shm_open"}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.a,{href:"https://man7.org/linux/man-pages/man3/shm_open.3.html",children:"shm_open"})," cr\xe9e et ouvre un nouveau POSIX ou ouvre un POSIX existant objet de m\xe9moire partag\xe9e. Un objet de m\xe9moire partag\xe9e POSIX est en vigueur un handle qui peut \xeatre utilis\xe9 par des processus non li\xe9s \xe0 ",(0,r.jsx)(s.code,{children:"mmap()"})," m\xeame r\xe9gion de m\xe9moire partag\xe9e. La fonction ",(0,r.jsx)(s.code,{children:"shm_unlink()"})," effectue l'op\xe9ration inverse, en supprimant un objet pr\xe9c\xe9demment cr\xe9\xe9 par ",(0,r.jsx)(s.code,{children:"shm_open()"}),"."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-rust",children:"pub fn shm_open<P>(name: &P, flag: OFlag, mode: Mode) -> Result<RawFd>\n"})}),"\n",(0,r.jsxs)(s.p,{children:["En cas de r\xe9ussite, ",(0,r.jsx)(s.code,{children:"shm_open()"})," renvoie un ",(0,r.jsx)(s.strong,{children:"nouveau descripteur de fichier"})," se r\xe9f\xe9rant \xe0 l'objet de m\xe9moire partag\xe9e. Ce descripteur de fichier est garanti d'\xeatre le descripteur de fichier avec le num\xe9ro le plus bas non pr\xe9c\xe9demment ouvert dans le cadre du processus."]}),"\n",(0,r.jsxs)(s.p,{children:["The file descriptor is normally used in subsequent calls to ",(0,r.jsx)(s.code,{children:"ftruncate()"})," (for a newly created object) and ",(0,r.jsx)(s.code,{children:"mmap()"}),". After a call to ",(0,r.jsx)(s.code,{children:"mmap()"})," the file descriptor may be closed without affecting the memory mapping."]}),"\n",(0,r.jsx)(s.h2,{id:"exercises",children:"Exercises"}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsx)(s.li,{children:"R\xe9solvez les lignes TODO (dans l'ordre) \xe0 partir de ex1."}),"\n",(0,r.jsx)(s.li,{children:"R\xe9solvez les lignes TODO (dans l'ordre) de ex2."}),"\n",(0,r.jsx)(s.li,{children:"R\xe9solvez les lignes TODO (dans l'ordre) de ex3."}),"\n"]})]})}function p(e={}){const{wrapper:s}={...(0,t.R)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},8453:(e,s,i)=>{i.d(s,{R:()=>l,x:()=>a});var n=i(6540);const r={},t=n.createContext(r);function l(e){const s=n.useContext(t);return n.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function a(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),n.createElement(t.Provider,{value:s},e.children)}}}]);